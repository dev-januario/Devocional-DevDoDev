name: WhatsApp Keep-Alive

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  keep-alive:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: For√ßar registry do npmjs
        run: |
          npm config set registry https://registry.npmjs.org/
          npm config get registry

      - name: Instalar depend√™ncias Node.js
        run: npm ci

      - name: Definir envs por branch
        shell: bash
        run: |
          echo "BRANCH=${GITHUB_REF_NAME}" >> $GITHUB_ENV

          if [[ "${GITHUB_REF_NAME}" == "main" ]]; then
            echo "GROUP_ID=${{ secrets.GROUP_ID_DEV }}" >> $GITHUB_ENV
          elif [[ "${GITHUB_REF_NAME}" == "development" ]]; then
            echo "GROUP_ID=${{ secrets.GROUP_ID_DEV }}" >> $GITHUB_ENV
          else
            echo "GROUP_ID=${{ secrets.GROUP_ID_DEV }}" >> $GITHUB_ENV
          fi

      - name: Gerar .env
        shell: bash
        run: |
          echo "GROUP_ID=${GROUP_ID}" > .env
          cat .env | sed 's/=.*/=***/'

      - name: Baixar auth mais recente (qualquer workflow)
        uses: dawidd6/action-download-artifact@v4
        continue-on-error: true
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow_search: true
          workflow_conclusion: success
          name: auth_info_baileys
          path: auth_info_baileys/
          search_artifacts: true
          if_no_artifact_found: ignore

      - name: Criar pasta auth_info_baileys do secret (fallback)
        if: ${{ hashFiles('auth_info_baileys/**') == '' }}
        run: |
          if [ -n "${{ secrets.AUTH_INFO_BAILEYS }}" ]; then
            mkdir -p auth_info_baileys
            echo "${{ secrets.AUTH_INFO_BAILEYS }}" | base64 --decode | tar -xz -C auth_info_baileys
            echo "‚úÖ Auth info restaurado do secret (fallback)"
          else
            echo "‚ùå Nenhum auth encontrado (nem artifact nem secret)"
            exit 1
          fi

      - name: Verificar conte√∫do do auth
        run: |
          echo "üìÇ Conte√∫do de auth_info_baileys:"
          ls -lah auth_info_baileys/
          echo "üìä Tamanho total:"
          du -sh auth_info_baileys/

      - name: Executar keep-alive
        run: |
          echo "üîÑ Renovando sess√£o WhatsApp..."
          npx tsx keep-alive.ts

      - name: Upload da pasta auth_info_baileys atualizada
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: auth_info_baileys
          path: auth_info_baileys/
          retention-days: 90

      - name: Relat√≥rio de sucesso
        if: success()
        run: |
          echo "‚úÖ Keep-alive conclu√≠do com sucesso!"
          echo "üìÖ Executado em: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "üîÑ Pr√≥xima execu√ß√£o em ~6 horas"
          echo ""
          echo "‚ÑπÔ∏è O auth atualizado foi salvo como artifact e ser√°"
          echo "   usado automaticamente pelos pr√≥ximos workflows."