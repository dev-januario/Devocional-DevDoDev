name: Devocional - Dev Do Dev - Envio Diário

on:
  schedule:
    - cron: '30 9 * * *'
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  devocional:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do código
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Instalar dependências Python
        run: pip install -r requirements.txt

      - name: Forçar registry do npmjs
        run: |
          npm config set registry https://registry.npmjs.org/
          npm config get registry

      - name: Instalar dependências Node.js
        run: npm ci

      - name: Definir envs por branch
        shell: bash
        run: |
          echo "BRANCH=${GITHUB_REF_NAME}" >> $GITHUB_ENV

          if [[ "${GITHUB_REF_NAME}" == "main" ]]; then
            echo "GROUP_ID=${{ secrets.GROUP_ID_MAIN }}" >> $GITHUB_ENV
          elif [[ "${GITHUB_REF_NAME}" == "development" ]]; then
            echo "GROUP_ID=${{ secrets.GROUP_ID_DEV }}" >> $GITHUB_ENV
          else
            echo "GROUP_ID=${{ secrets.GROUP_ID_DEV }}" >> $GITHUB_ENV
          fi

          echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> $GITHUB_ENV

      - name: Gerar .env
        shell: bash
        run: |
          echo "GROUP_ID=${GROUP_ID}" > .env
          echo "GEMINI_API_KEY=${GEMINI_API_KEY}" >> .env
          cat .env | sed 's/=.*/=***/'

      - name: Restaurar auth da branch auth
        run: |
          git fetch origin auth
          git checkout origin/auth -- auth_info_baileys/
          echo "✅ Auth restaurado da branch auth"

      - name: Baixar database.zip do último run
        uses: dawidd6/action-download-artifact@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow: devocional.yml
          name: database
          path: .
          if_no_artifact_found: warn

      - name: Extrair database.zip (se existir)
        run: |
          if [ -f database.zip ]; then
            unzip -o database.zip
            echo "database.zip extraído."
          else
            echo "Nenhum database.zip encontrado. Primeira execução?"
          fi

      - name: Executar script Python (gerar conteúdo)
        run: python main.py

      - name: Verificar se outbox.txt foi gerado
        run: |
          if [ ! -f outbox.txt ]; then
            echo "❌ ERRO: outbox.txt não foi gerado pelo Python"
            exit 1
          fi
          echo "✅ outbox.txt encontrado"
          echo "Conteúdo:"
          head -n 10 outbox.txt

      - name: Enviar mensagem via WhatsApp
        env:
          GROUP_ID: ${{ github.ref == 'refs/heads/main' && secrets.GROUP_ID_MAIN || secrets.GROUP_ID_DEV }}
        run: npx tsx index-send-message.ts

      - name: Verificar status do envio
        run: |
          if [ -f send_status.json ]; then
            echo "Status do envio:"
            cat send_status.json
            
            if grep -q '"success": *true' send_status.json; then
              echo "✅ Mensagem enviada com sucesso!"
              exit 0
            else
              echo "❌ Falha no envio da mensagem"
              exit 1
            fi
          else
            echo "❌ send_status.json não foi gerado"
            exit 1
          fi

      - name: Atualizar auth na branch auth
        if: always()
        run: |
          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"

          # Salva os creds atualizados em pasta temporária
          cp -r auth_info_baileys /tmp/auth_info_baileys

          # Vai para a branch auth
          git fetch origin auth
          git checkout auth

          # Copia os creds atualizados
          rm -rf auth_info_baileys
          cp -r /tmp/auth_info_baileys auth_info_baileys

          git add auth_info_baileys/
          git diff --cached --quiet && echo "Nada a commitar" || git commit -m "chore: update auth [skip ci]"
          git push origin auth

          # Volta para a branch original
          git checkout ${{ github.ref_name }}

      - name: Empacotar database.zip
        if: success()
        run: |
          if [ -f database.db ]; then
            zip database.zip database.db
            echo "database.zip criado."
          else
            echo "ATENÇÃO: database.db não encontrado. Nada foi empacotado."
            ls -la
          fi

      - name: Upload do outbox.txt
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: outbox
          path: outbox.txt
          if-no-files-found: ignore

      - name: Upload do database
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: database
          path: database.zip
          if-no-files-found: warn