name: Enviar Devocional Diário

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  devocional:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Instalar dependências Python
        run: pip install -r requirements.txt

      - name: Forçar registry do npmjs
        run: |
          npm config set registry https://registry.npmjs.org/
          npm config get registry

      - name: Reset registry
        run: |
            npm config delete registry
            npm config set registry https://registry.npmjs.org/

      - name: Instalar dependências Node.js
        run: npm ci

      - name: Criar arquivo .env
        run: |
          echo "GROUP_ID=${{ secrets.GROUP_ID }}" >> .env
          echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> .env

      - name: Criar pasta auth_info_baileys (se existir secret)
        run: |
          if [ -n "${{ secrets.AUTH_INFO_BAILEYS }}" ]; then
            mkdir -p auth_info_baileys
            # O secret deve ser um tar.gz em base64
            echo "${{ secrets.AUTH_INFO_BAILEYS }}" | base64 --decode | tar -xz -C auth_info_baileys
          else
            echo "Secret AUTH_INFO_BAILEYS não encontrado. O bot tentará autenticar via QR, mas falhará."
          fi

      - name: Executar script Python
        run: python main.py

      - name: Upload do banco de dados (opcional, para backup)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: database
          path: database.db

      - name: Upload da pasta auth_info_baileys atualizada (opcional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: auth_info_baileys
          path: auth_info_baileys/
