name: Enviar Devocional Diário

on:
  schedule:
    - cron: '0 10 * * *'
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  devocional:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do código
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Instalar dependências Python
        run: pip install -r requirements.txt

      - name: Forçar registry do npmjs
        run: |
          npm config set registry https://registry.npmjs.org/
          npm config get registry

      - name: Instalar dependências Node.js
        run: npm ci

      - name: Definir envs por branch
        shell: bash
        run: |
          echo "BRANCH=${GITHUB_REF_NAME}" >> $GITHUB_ENV

          if [[ "${GITHUB_REF_NAME}" == "main" ]]; then
            echo "GROUP_ID=${{ secrets.GROUP_ID_MAIN }}" >> $GITHUB_ENV
          elif [[ "${GITHUB_REF_NAME}" == "development" ]]; then
            echo "GROUP_ID=${{ secrets.GROUP_ID_DEV }}" >> $GITHUB_ENV
          else
            # fallback (feature/*, etc.)
            echo "GROUP_ID=${{ secrets.GROUP_ID_DEV }}" >> $GITHUB_ENV
          fi

          echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> $GITHUB_ENV

          echo "Branch detectada: ${GITHUB_REF_NAME}"
          echo "GROUP_ID definido? (não vou printar valor por segurança)"

      - name: Gerar .env (opcional)
        shell: bash
        run: |
          echo "GROUP_ID=${GROUP_ID}" > .env
          echo "GEMINI_API_KEY=${GEMINI_API_KEY}" >> .env

      - name: Criar pasta auth_info_baileys (se existir secret)
        run: |
          if [ -n "${{ secrets.AUTH_INFO_BAILEYS }}" ]; then
            mkdir -p auth_info_baileys
            # O secret deve ser um tar.gz em base64
            echo "${{ secrets.AUTH_INFO_BAILEYS }}" | base64 --decode | tar -xz -C auth_info_baileys
          else
            echo "Secret AUTH_INFO_BAILEYS não encontrado. O bot tentará autenticar via QR, mas falhará."
          fi

      - name: Baixar database.zip do último run (se existir)
        uses: dawidd6/action-download-artifact@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow: devocional.yml
          name: database
          path: .
          if_no_artifact_found: warn

      - name: Extrair database.zip (se existir)
        run: |
          if [ -f database.zip ]; then
            unzip -o database.zip
          fi

      - name: Executar script Python
        run: python main.py

      - name: Upload do outbox.txt (backup)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: outbox
          path: outbox.txt
          if-no-files-found: ignore

      - name: Upload do banco
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: database
          path: database.zip
          if-no-files-found: warn

      - name: Upload do banco
        uses: actions/upload-artifact@v4
        with:
          name: database
          path: database.zip

      - name: Upload da pasta auth_info_baileys atualizada (opcional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: auth_info_baileys
          path: auth_info_baileys/
